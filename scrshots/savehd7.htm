<html>
<head>
<meta charset="utf-8" />
<title>
Seed7 Program: Savehd7</title>
<meta name="author" content="Thomas Mertes" />
<meta name="copyright" content="Thomas Mertes" />
<meta name="keywords" content="Seed7, SeedSeven, Seed, Seven, 7, programming, language, extensible, extendable" />
<meta name="description" content="Seed7 - The extensible programming language" />
<meta name="page-topic" content="programming language, computer, software, downloads" />
<meta name="audience" content="all" />
<meta name="content-language" content="en" />
<meta name="robots" content="index,follow" />
<link rel="shortcut icon" href="../images/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="../style3.css" type="text/css" />
</head>
<body style="margin:0 0 0 0;">
<div style="background-image: url('../images/header1x.png');" class="top_image">
<img style="overflow:hidden;" src="../images/hearts7m.png" height="68" width="50"
 /><img style="overflow:hidden;" src="../images/header3.png" height="68" width="745" />
</div>
<div style="background-image: url('../images/fillpix.png');" class="space_below_top_image">
</div>
<div class="menu">

<a class="head" href="../index.htm"><big>Seed7</big></a>
<a class="menu" href="../faq.htm">FAQ</a>
<a class="menu" href="../manual/index.htm">Manual</a>
<a class="menu" href="../scrshots/index.htm">Programs</a>
<a class="menu" href="../examples/index.htm">Examples</a>
<a class="menu" href="../libraries/index.htm">Libraries</a>
<a class="menu" href="../algorith/index.htm">Algorithms</a>
<a class="menu" href="../benchmks/index.htm">Benchmarks</a>
<a class="menu" href="../subject_index.htm">Index</a>
<a class="menu" href="http://sourceforge.net/project/showfiles.php?group_id=151126">Download</a>
<a class="menu" href="https://github.com/ThomasMertes/seed7">GitHub</a>
<a class="menu" href="../build.htm">Build Seed7</a>
<a class="menu" href="../links.htm">Links</a>

<br />

<a class="head" href="index.htm"><big>Programs</big></a>
<a class="menu" href="panic.htm">Panic</a>
<a class="menu" href="mandelbr.htm">Mandelbr</a>
<a class="menu" href="planets.htm">Planets</a>
<a class="menu" href="comanche.htm">Comanche</a>
<a class="menu" href="calc7.htm">Calc7</a>
<a class="menu" href="savehd7.htm">Savehd7</a>
<a class="menu" href="s7c.htm">Compiler</a>
<a class="menu" href="db7.htm">Db7</a>
<a class="menu" href="ide7.htm">Ide7</a>
<a class="menu" href="klondike.htm">Klondike</a>
<a class="menu" href="dnafight.htm">Dnafight</a>
<a class="menu" href="sudoku7.htm">Sudoku</a>
<a class="menu" href="wator.htm">Wator</a>
<a class="menu" href="tar7.htm">Tar7</a>
<a class="menu" href="sydir7.htm">Sydir7</a>
<a class="menu" href="ftp7.htm">Ftp7</a>
<a class="menu" href="castle.htm">Castle</a>
<a class="menu" href="tetg.htm">Tetris</a>
<a class="menu" href="make7.htm">Make7</a>
<a class="menu" href="ftpserv.htm">Ftpserv</a>
<a class="menu" href="bas7.htm">Basic</a>
<a class="menu" href="gkbd.htm">Gkbd</a>
<a class="menu" href="pairs.htm">Pairs</a>
<a class="menu" href="shisen.htm">Shisen</a>
<a class="menu" href="eliza.htm">Eliza</a>
<a class="menu" href="../algorith/graphic.htm#dragon_curve">Dragon</a>
<a class="menu" href="../images/testfont1.png">Fonts</a>
<a class="menu" href="toutf8.htm">Toutf8</a>
<a class="menu" href="lander.htm">Lander</a>
<a class="menu" href="wiz.htm">Wiz</a>
<a class="menu" href="startrek.htm">Startrek</a>
<a class="menu" href="../images/dirx1.png">Directory</a>
<a class="menu" href="../algorith/graphic.htm#bifurk">Bifurc</a>
<a class="menu" href="mahjong.htm">Mahjong</a>
<a class="menu" href="../images/rever1.png">Reversi</a>
<a class="menu" href="sokoban.htm">Sokoban</a>
<a class="menu" href="../algorith/graphic.htm#cellauto">Cellauto</a>
<a class="menu" href="sl.htm">Life</a>
<a class="menu" href="../images/snake1.png">Snake</a>
<a class="menu" href="self.htm">Self</a>
<a class="menu" href="../images/carddemo1.png">Cards</a>
<a class="menu" href="../images/ms1.png">Mines</a>
<a class="menu" href="../images/pac1.png">Pacman</a>
</div>
<div class="content">
<div style="padding-right:20;">
<table width="100%" cellpadding="0" cellspacing="0">
<tr>
<td align="left" width="80">
<a class="head" href="index.htm"><big>Programs</big></a>
</td>
<td>
<table width="10">
</table>
</td>
<td align="left" width="60%">
<b><big>Savehd7</big></b></td>
<td align="right"><a class="link" href="../prg/savehd7.htm">Source&nbsp;Code</a></td>
<td>
<table width="10">
</table>
</td>
<td align="right">
<table border="0" cellspacing="1" bgcolor="blue">
<tr bgcolor="gainsboro">
<td>&nbsp;<a class="navigation" href="../scrshots/calc7.htm">previous</a>&nbsp;</td>
<td>&nbsp;<a class="navigation" href="../scrshots/index.htm">up</a>&nbsp;</td>
<td>&nbsp;<a class="navigation" href="../scrshots/s7c.htm">next</a>&nbsp;</td>
</tr>
</table>
</td>
</tr>
</table>
<br />
<table cellspacing="0" border="0">
<tr valign="top">
<td align="left" width="100%">

<p>
Savehd7 saves a potentially damaged harddisk partition to an image
file. Savehd7 works for all filesystems. Calling Savehd7 with <tt>-h</tt>
gives some helping explanations.
</p>

<div><a name="rationale"><h3>Rationale</h3></a>
<p>
Harddisks are not 100% reliable and over time they can acquire bad
blocks (which cannot be fixed by the firmware). Reading a bad block
will cause the operating system to report an error or to return
garbage. Writing to a damaged partition can even cause the filesystem
to become corrupt. For this reason a file system checker should not
be used when there are read or write errors. To fix the filesystem it
is necessary to copy the whole partition to a file. Tools like 'cp'
or 'cat' are unusable to copy a damaged partition, since they will
abort on a read error. With conv=noerror 'dd' will proceed, but it
will just try to copy all blocks sequentially. A smarter approach
which jumps over bad blocks and maintains a list of bad block areas
would be helpful.
</p><p>
The Savehd7 program is designed to copy from a device file to a disk
image file even when read errors occur. It will try to copy as much
as possible and leave the unreadable blocks filled with zero bytes.
The file system checker can fix the saved disk image afterwards.
Finally the saved and repaired disk image file can be mounted with
the loop mount feature (which can mount a file as if it is a device).
</p><p>
Savehd7 tries to jump over bad blocks to reach a high rate of good
blocks in relative small time. In later phases it will try to shrink
the areas with possible bad blocks without trying to read bad blocks
too much. This way the rate of good blocks is increased without
spending too much time. Just the final phase will try to read all
blocks still marked as bad.
</p><p>
Savdhd7 maintains a list of potential bad areas and the processing
state. It can be paused by pressing a key and is able to continue
afterwards. This way the partition image can be mounted much
earlier. When a read only mount was used the saving process can
continue afterwards.
</p></div>

<div><a name="usage"><h3>Usage</h3></a>
<p>
Several conditions must be fulfilled to use Savehd7:
</p><ul>
  <li>Operating systems without device files are not supported.</li>

  <li>To get access to the device file Savehd7 needs to be started as
    superuser.</li>

  <li>Nothing should be mounted on the device file processed by
    Savehd7.</li>

  <li>Programs which possibly change the device file such as
    filesystem checkers should not run in parallel to Savehd7.</li>

  <li>There must be enough free space on the destination device
    to copy the whole partition.</li>
</ul><p>
When Savehd7 is called it asks for the device file which should be
used as input:
</p><pre class="indent">
root@penguin:~# /home/tm/seed7_5/prg/savehd7
Savehd7 Version 2.0 - Save a possibly damaged harddisk partition
Copyright (C) 2006, 2009 Thomas Mertes
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
Savehd7 is written in the Seed7 programming language
Homepage: http://seed7.sourceforge.net
Use 'savehd7 -h' to get more information

Please enter the conditions to save the partition:
  Input file name:
</pre><p>
After entering e.g. <tt>/dev/sda3</tt> (and pressing enter) it asks
for the output file:
</p><pre class="indent">
  Output file name:
</pre><p>
After entering e.g. <tt>sda3</tt> (and pressing enter) it writes
information about the current state and asks for confirmation:
</p><pre class="indent">
Conditions to save the partition:
  Input file name:  /dev/sda3
  Input file size:  60620313600
  Output file name: sda3
  State:            Nothing saved

Should the save start (type 'Yes' to confirm)?
</pre><p>
After entering <tt>Yes</tt> (and pressing enter) it starts the
saving process:
</p><pre class="indent">
Processing - Press any key to pause (may take some time to react)
        progress:      okay:  bad blks:     fixed:   bad bytes:
copy      0.0000%    0.0000%    0.0000%    0.0000%            0
</pre><p>
The last line is updated to document the progress:
</p><pre class="indent">
Processing - Press any key to pause (may take some time to react)
        progress:      okay:  bad blks:     fixed:   bad bytes:
copy      2.6568%    2.6568%    0.0000%    0.0000%            0
</pre><p>
The terms of the progress description are:
</p><table border="0" cellspacing="0">
<tr>
<td width="20"></td><td>copy</td>
<td width="10"></td><td>The current saving phase. Phases are:
                        <tt>copy</tt>, <tt>improve</tt>, <tt>examine</tt> and <tt>fix</tt>.</td>
</tr>
<tr>
<td width="20"></td><td>progress</td>
<td width="10"></td><td>The progress of the current phase.</td>
</tr>
<tr>
<td width="20"></td><td>okay</td>
<td width="10"></td><td>Percentage of data found okay.</td>
</tr>
<tr>
<td width="20"></td><td>bad blks</td>
<td width="10"></td><td>Percentage of bad blocks found.</td>
</tr>
<tr>
<td width="20"></td><td>fixed</td>
<td width="10"></td><td>Percentage of fixed potential bad blocks.</td>
</tr>
<tr>
<td width="20"></td><td>bad bytes</td>
<td width="10"></td><td>Bytes in potential bad areas.</td>
</tr>
</table><p>
Operating systems usually retry to read bad blocks again and again
in the hope to succeed finally. Therefore copying from a damaged
harddisk can take very long (many hours even up to several days).
When Savehd7 is processing it can be interrupted by pressing any
key:
</p><pre class="indent">
Processing - Press any key to pause (may take some time to react)
        progress:      okay:  bad blks:     fixed:   bad bytes:
copy     11.5099%   11.5009%    0.0089%    0.0000%      5431296

Copy paused - To continue restart the program

root@penguin:~#
</pre><p>
Since the OS spends so much time reading bad blocks it may take
some time until Savehd7 has a chance to save the processing state
and exit afterwards. Savehd7 should not be interrupted with
control-C or some other signal, since this prevents saving the
processing state. When Savehd7 is restarted it is prepared to
continue at the position where it was interrupted:
</p><pre class="indent">
root@penguin:~# /home/tm/seed7_5/prg/savehd7
Savehd7 Version 2.0 - Save a possibly damaged harddisk partition
Copyright (C) 2006, 2009 Thomas Mertes
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
Savehd7 is written in the Seed7 programming language
Homepage: http://seed7.sourceforge.net
Use 'savehd7 -h' to get more information

Conditions to save the partition:
  Input file name:  /dev/sda3
  Input file size:  60620313600
  Output file name: sda3
  Output file size: 6977368064
  State:            Copy - 11.5099% done
  Total bad bytes:  5431296

Should the bad areas be listed (Y/N/Q)?
</pre><p>
When answering <tt>'Y'</tt> Savehd7 writes a list of
potential bad areas:
</p><pre class="indent">
List of bad areas:
   position   size
  1610678273 983040
  1744863233 1015808
  1879117825 978944
  2147618817 913408
  2281832449 917504
  2416001025 61440
  2550255617 24576
  2818605057 110592
  2952847361 86016
  3087093761 57344
  3221270529 98304
  3355521025 65536
  3489746945 57344
  6442532865 61440

Should the save continue (type 'Yes' to confirm)?
</pre><p>
After entering <tt>Yes</tt> Savehd7 continues the saving process.
</p></div>

<div><a name="operation_method"><h3>Operation method</h3></a>
<p>
The file <span class="stri">"savehd7.dat"</span> is used to maintain the processing state.
Savehd7 writes also logging information to the file <span class="stri">"savehd7.log"</span>.
</p><p>
Savehd7 saves the harddisk partition in several phases:
</p><ul>
  <li>During the <tt>'copy'</tt> phase a sequential copy
    with chunks of 16384 Bytes (2 ** 14 Bytes) takes place. When the <tt>'read'</tt>
    function of the operating system returns a partial chunk, the
    rest of the destination chunk is filled with zero bytes and
    marked as potential bad area. The processing continues 1 MiB
    (2 ** 20 Bytes) forward and the bytes in the gap are also
    filled with zero bytes and marked as potential bad area. Bad
    areas are maintained in the file <span class="stri">"savehd7.dat"</span>. The big skip
    size of 1 MiB is used to jump over hopefully small areas with
    real bad blocks. This way a good deal of the data is copied
    in a relatively small period.</li>

  <li>During the optional <tt>'reread'</tt> phase chunks of 16384 Bytes
    are read sequentially and compared to the chunks read by the
    <tt>'copy'</tt> phase. This comparison is done with blocks of 512 Bytes.
    When both elements are not identical the corresponding 512 Byte
    block is marked as potential bad area. When an element is only
    present in one of the phases (<tt>'copy'</tt> and <tt>'reread'</tt>) the existing
    element is assumed to be okay.</li>

  <li>During the <tt>'improve'</tt> phase potential bad areas are processed
    one by one. Savehd7 reads 512 Byte blocks from the end of each
    potential bad area towards its beginning. The processing of a
    potential bad block area is terminated when a read operation
    fails. In this case the processing moves to the next potential
    bad block area. The <tt>'improve'</tt> phase reduces the size of the
    areas in the bad area list by a high percentage.</li>

  <li>During the <tt>'examine'</tt> phase potential bad areas are processed
    one by one. Savehd7 reads 512 Byte blocks from the middle of
    each potential bad area towards its end and its beginning. At
    first blocks are read forward until a read operation fails or
    the end is reached. Then blocks are read backward until a read
    operation fails or the beginning is reached. If the potential
    bad area was split into two both new areas are processed in the
    same way. If not, the processing moves to the next potential
    bad block area.

  <li>During the <tt>'fix'</tt> phase the potential bad areas are processed
    one by one. Savehd7 reads 512 Byte blocks from the end of each
    potential bad area towards its beginning. The processing of a
    potential bad block area is continued even when read operations
    fail. This way Savehd7 attempts to read blocks of 512 Byte in
    all areas of the bad area list. Since this phase reads small
    blocks in areas with many potential bad blocks it takes
    extremely long.</li>
</ul></div>

<div><a name="download"><h3>Download</h3></a>
<p>
Savehd7 is written in the <a class="link" href="../index.htm">Seed7</a> programming language and can be
downloaded as part of the <a class="link" href="http://sourceforge.net/project/showfiles.php?group_id=151126">Seed7 package</a>.
To use savehd7 it is necessary to <a class="link" href="../faq.htm#compile_interpreter">compile the Seed7 interpreter</a>.
Afterwards Savehd7 can be started from the directory <nobr>'seed7/prg'</nobr> with:
</p><pre class="indent">
s7 savehd7
</pre><p>
Savehd7 can be also compiled with:
</p><pre class="indent">
s7c savehd7
</pre><p>
This creates an executable which can be used without the <tt>'s7'</tt> interpreter.
</p></div>
</td>
<td>
<table width="10">
</table>
</td>
<td>
<table cellspacing="0" cellpadding="0" border="0">
<tbody>
<tr valign="top" align="center">
<td><a href="../images/savehd7_1.png"><img src="../images/savehd7_1m.png" border="0" /></a><br />Savehd7 called with -h</td></tr>
<tr height="20"><td></td></tr>
<tr valign="top" align="center">
<td><a href="../images/savehd7_2.png"><img src="../images/savehd7_2m.png" border="0" /></a><br />Start saving a partition</td></tr>
<tr height="20"><td></td></tr>
<tr valign="top" align="center">
<td><a href="../images/savehd7_3.png"><img src="../images/savehd7_3m.png" border="0" /></a><br />Pause and restart Savehd7</td></tr>
<tr height="20"><td></td></tr>
<tr valign="top" align="center">
<td><a href="../images/savehd7_4.png"><img src="../images/savehd7_4m.png" border="0" /></a><br />Improve phase</td></tr>
<tr height="20"><td></td></tr>
<tr valign="top" align="center">
<td><a href="../images/savehd7_5.png"><img src="../images/savehd7_5m.png" border="0" /></a><br />Complete run</td></tr>
<tr height="20"><td></td></tr>
</tbody>
</table>
</td>
</tr>
</table>
<table width="100%" cellpadding="0" cellspacing="0">
<tr>
<td align="left" width="60%">
<b><big><hr \></big></b></td>
<td align="right">
<table border="0" cellspacing="1" bgcolor="blue">
<tr bgcolor="gainsboro">
<td>&nbsp;<a class="navigation" href="../scrshots/calc7.htm">previous</a>&nbsp;</td>
<td>&nbsp;<a class="navigation" href="../scrshots/index.htm">up</a>&nbsp;</td>
<td>&nbsp;<a class="navigation" href="../scrshots/s7c.htm">next</a>&nbsp;</td>
</tr>
</table>
</td>
</tr>
</table>
</div>
</div>
  </body>
</html>
